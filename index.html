<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Senul Seettu Random Number</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  margin: 0;
  padding: 20px;
  background: url('https://cdn.shopify.com/s/files/1/1279/9999/files/CasinoSupply-319669-roulette-table-players-image-a1.jpg?v=1724267235') no-repeat center center fixed;
  background-size: cover;
  position: relative;
}
body::before {
  content: "";
  position: absolute;
  top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.7);
  z-index:0;
}
* {position: relative; z-index:1;}
h1 {color:#333; margin-bottom:10px;}
.card-container {display:flex; flex-wrap:wrap; justify-content:center; max-width:700px; margin-top:20px;}
.card {
  width:100px; height:140px; background:#fff; border-radius:10px; margin:10px;
  display:flex; align-items:center; justify-content:center; font-size:30px; cursor:pointer; transition: transform 0.5s, background 0.5s;
  box-shadow:0 4px 8px rgba(0,0,0,0.2);
}
.flipped {background:#4CAF50; color:white; transform:rotateY(0deg);}
.admin-panel {display:none; flex-direction:column; align-items:center; background:#f9f9f9; padding:20px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2); margin-top:20px;}
input, button {padding:10px; border:none; border-radius:5px; margin:5px;}
input {width:200px;}
button {background-color:#4CAF50; color:white; cursor:pointer;}
#login-section {display:flex; flex-direction:column; align-items:center; margin-top:20px;}
#footer {margin-top:30px; color:gray;}
</style>
</head>
<body>
<h1>üé≤ Senul Seettu Random Number üé≤</h1>

<div id="name-section">
<input type="text" id="username" placeholder="Enter Your Full Name" />
<button id="startBtn">Start</button>
</div>

<div class="card-container" id="cards" style="display:none;"></div>

<div id="login-section">
<input type="password" id="adminPass" placeholder="Admin Password" />
<button id="loginBtn">Admin Login</button>
</div>

<div class="admin-panel" id="adminPanel">
<h2>üßë‚Äçüíº Admin Panel</h2>
<label>Total Players: <input type="number" id="totalPlayers" min="2" value="10"></label>
<button id="setPlayersBtn">Set Players</button>

<h3>Assign Number Manually</h3>
<input type="text" id="manualName" placeholder="Player Name">
<input type="number" id="manualNumber" placeholder="Number">
<button id="assignBtn">Assign</button>

<h3>Assigned Numbers</h3>
<div id="results"></div>
<button id="resetBtn">üîÑ Reset All</button>
<button id="exportBtn">üì• Export as PNG</button>
</div>

<div id="footer">¬© Theekshana Viduranga</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyACPs6N80C3i8SS3aG7ahybThWvsPSf19o",
  authDomain: "senul-80301.firebaseapp.com",
  databaseURL: "https://senul-80301-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "senul-80301",
  storageBucket: "senul-80301.appspot.com",
  messagingSenderId: "718343352275",
  appId: "1:718343352275:web:7c0e22dd69981690df8926",
  measurementId: "G-KFYWFF619M"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let totalPlayers = 10;
let allNumbers = [];
let availableNumbers = [];
let assigned = [];

const startBtn = document.getElementById("startBtn");
const usernameInput = document.getElementById("username");
const cardsContainer = document.getElementById("cards");
const adminPanel = document.getElementById("adminPanel");
const results = document.getElementById("results");

// Load totalPlayers from DB
db.ref("totalPlayers").once("value").then(snapshot=>{
  const val = snapshot.val();
  if(val) totalPlayers = val;
  document.getElementById("totalPlayers").value = totalPlayers;
  updateAvailableNumbers();
});

// Load assigned numbers
function loadData(){
  db.ref("assigned").once("value").then(snapshot=>{
    assigned = snapshot.val() || [];
    updateAvailableNumbers();
    if(adminPanel.style.display==="flex") displayResults();
  });
}

// Update available numbers
function updateAvailableNumbers(){
  allNumbers = [];
  for(let i=2;i<=totalPlayers;i++) allNumbers.push(i);
  availableNumbers = allNumbers.filter(n => !assigned.find(a=>a.number===n && !a.adminAssigned));
}

// Display admin results
function displayResults(){
  if(assigned.length===0){
    results.innerHTML="<p>No numbers assigned yet.</p>";
  }else{
    results.innerHTML = assigned.map(d=>`<p>${d.name} ‚Üí ${d.number}</p>`).join("");
  }
}

// Generate cards dynamically
function generateCards(username){
  updateAvailableNumbers();
  cardsContainer.innerHTML = "";
  const cardsToGenerate = totalPlayers - 1;

  for(let i=0; i<cardsToGenerate; i++){
    const card = document.createElement("div");
    card.className = "card";
    card.innerText = "‚ùì";

    card.onclick = ()=>{
      if(card.classList.contains("flipped")) return;
      updateAvailableNumbers();
      if(availableNumbers.length===0) return alert("Numbers exhausted!");

      // Check if player has admin-assigned number
      let playerObj = assigned.find(a=>a.name===username && a.adminAssigned);
      let number;
      if(playerObj){
        number = playerObj.number;
      } else {
        const randomIndex = Math.floor(Math.random()*availableNumbers.length);
        number = availableNumbers[randomIndex];
      }

      availableNumbers = availableNumbers.filter(n => n!==number);

      if(!assigned.find(a=>a.name===username)){
        assigned.push({name:username, number:number, adminAssigned:!!playerObj});
        db.ref("assigned").set(assigned);
      }

      card.classList.add("flipped");
      card.innerText = number;
      alert(`${username} got number ${number}!`);
    };

    cardsContainer.appendChild(card);
  }
}

// Start button click
startBtn.onclick = ()=>{
  const username = usernameInput.value.trim();
  if(!username) return alert("Please enter your full name!");
  document.getElementById("name-section").style.display="none";
  cardsContainer.style.display="flex";
  generateCards(username);
};

// Admin login
document.getElementById("loginBtn").onclick=()=>{
  const pass = document.getElementById("adminPass").value;
  if(pass==="Senul123"){
    document.getElementById("login-section").style.display="none";
    adminPanel.style.display="flex";
    loadData();
  } else alert("Wrong Password!");
};

// Set total players
document.getElementById("setPlayersBtn").onclick=()=>{
  const val = parseInt(document.getElementById("totalPlayers").value);
  if(val<2) return alert("Minimum 2 players required!");
  totalPlayers = val;
  db.ref("totalPlayers").set(totalPlayers); // save in Firebase
  updateAvailableNumbers();
  alert(`Total players set to ${totalPlayers}. Cards will be ${totalPlayers-1}.`);
};

// Admin manual assign
document.getElementById("assignBtn").onclick=()=>{
  const name = document.getElementById("manualName").value.trim();
  const num = parseInt(document.getElementById("manualNumber").value);
  if(!name || !num) return alert("Name and Number required!");
  if(num<2 || num>totalPlayers) return alert(`Number must be between 2 and ${totalPlayers}`);

  assigned = assigned.filter(a=>a.name!==name);
  assigned.push({name:name, number:num, adminAssigned:true});
  db.ref("assigned").set(assigned);
  displayResults();
  alert(`Number ${num} assigned to ${name}`);
};

// Reset button
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Are you sure you want to reset all?")){
    db.ref("assigned").set([]);
    db.ref("totalPlayers").set(10);
    location.reload();
  }
};

// Export as PNG
document.getElementById("exportBtn").onclick=()=>{
  html2canvas(results).then(canvas=>{
    const link = document.createElement("a");
    link.download = 'assigned_numbers.png';
    link.href = canvas.toDataURL();
    link.click();
  });
};

// Listen for live updates
db.ref("assigned").on("value", snapshot=>{
  assigned = snapshot.val() || [];
  updateAvailableNumbers();
  if(adminPanel.style.display==="flex") displayResults();
});
db.ref("totalPlayers").on("value", snapshot=>{
  const val = snapshot.val();
  if(val) totalPlayers = val;
  document.getElementById("totalPlayers").value = totalPlayers;
  updateAvailableNumbers();
});
</script>
</body>
</html>
